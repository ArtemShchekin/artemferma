# Читаем stdout/stderr контейнера ferm-nginx
[sources.nginx_docker]
type = "docker_logs"
include_containers = ["ferm-nginx"]

# Пытаемся распарсить строку как JSON (ты уже пишешь nginx access_log в JSON)
[transforms.nginx_json]
type   = "remap"
inputs = ["nginx_docker"]
source = '''
if exists(.message) {
  parsed, err = parse_json(.message)
  if err == null { . = merge(., parsed) }
}
# Нормализуем время, если было поле "time"
if exists(.time) {
  ts, err = to_timestamp(.time)
  if err == null { ."@timestamp" = ts }
}
.source = "nginx"
'''

# Шлём в OpenSearch в индекс ferm-logs
[sinks.opensearch]
type       = "elasticsearch"
inputs     = ["nginx_json"]
endpoints  = ["http://opensearch:9200"]
index      = "ferm-logs"
mode       = "bulk"
compression = "none"
