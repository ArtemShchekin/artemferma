# Читаем stdout/stderr контейнера ferm-nginx
[sources.nginx_docker]
type = "docker_logs"
include_containers = ["ferm-nginx"]

# Пытаемся распарсить строку как JSON (ты уже пишешь nginx access_log в JSON)
[transforms.nginx_json]
type   = "remap"
inputs = ["nginx_docker"]
source = '''
# парсим JSON из строки docker-лога
parsed, err = parse_json(.message)
if err == null {
  . = merge(., parsed)
  del(.message)
}

# нормализуем время, если есть
if exists(.time) {
  ts, err = to_timestamp(.time)
  if err == null { .["@timestamp"] = ts }
}

.source = "nginx"
'''

# Шлём в OpenSearch в индекс ferm-logs
[sinks.opensearch]
type   = "elasticsearch"
inputs = ["nginx_json"]
endpoint = "http://opensearch:9200"   # ← можно вместо endpoints=[]
index  = "ferm-logs"
mode   = "bulk"
healthcheck = true
