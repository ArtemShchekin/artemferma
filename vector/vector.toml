# Читаем stdout контейнера ferm-nginx
[sources.nginx]
type = "docker_logs"
include_containers = ["ferm-nginx"]
include_stdout = true
include_stderr = false

# Отфильтровываем только JSON-строки (наши access_log)
[transforms.only_json]
type = "filter"
inputs = ["nginx"]
condition = '.message.starts_with("{")'

# Парсим JSON и выставляем @timestamp
[transforms.parse]
type = "remap"
inputs = ["only_json"]
source = '''
. = parse_json!(.message)
."@timestamp" = .time
del(.time)
.service = "nginx"
'''

# Пишем в OpenSearch (совместимый sink Elasticsearch)
[sinks.opensearch]
type = "elasticsearch"
inputs = ["parse"]
endpoints = ["http://opensearch:9200"]
index = "ferm-logs"
mode = "bulk"
