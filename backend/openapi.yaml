
openapi: 3.0.3
info:
  title: Artem Ferm API
  version: 1.0.0
  description: |
    Коллекцию можно скачать в формате JSON по ссылке [/api/docs/openapi.json](/api/docs/openapi.json).
externalDocs:
  description: Импортировать коллекцию в Postman
  url: /api/docs/openapi.json
servers:
  - url: /api
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    AuthRegisterReq:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 6
          maxLength: 20
          description: Латиница, минимум одна цифра
    AuthLoginReq:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string }
    AuthTokens:
      type: object
      required: [accessToken, refreshToken]
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
    AuthRegisterResp:
      allOf:
        - $ref: '#/components/schemas/AuthTokens'
        - type: object
          properties:
            message:
              type: string
    AuthRefreshReq:
      type: object
      required: [refreshToken]
      properties:
        refreshToken:
          type: string
    Profile:
      type: object
      properties:
        id:
          type: integer
          readOnly: true
        isCoolFarmer: { type: boolean }
        isAdmin:
          type: boolean
          readOnly: true
        firstName: { type: string, nullable: true }
        lastName: { type: string, nullable: true }
        middleName: { type: string, nullable: true }
        nickname:
          type: string
          nullable: true
          description: "Доступно только для крутых фермеров"
        passport:
          type: string
          nullable: true
          description: "Доступно только для крутых фермеров"
        level:
          type: integer
          minimum: 1
          maximum: 2
          readOnly: true
        soldCount:
          type: integer
          readOnly: true
        balance:
          type: integer
          readOnly: true
        yogurtMl:
          type: integer
          minimum: 0
          readOnly: true
        sunflowerOilMl:
          type: integer
          minimum: 0
          readOnly: true
        saladsEaten:
          type: integer
          minimum: 0
          readOnly: true
        isFatFarmer:
          type: boolean
          readOnly: true
        prices:
          allOf:
            - $ref: '#/components/schemas/ShopPrices'
          readOnly: true
    ProfileUpdateReq:
      type: object
      required: [isCoolFarmer]
      properties:
        isCoolFarmer:
          type: boolean
          description: |
            Определяет режим обновления профиля.
            Для крутого фермера (true) требуется указать nickname и passport.
            Для обычного (false) требуются firstName, lastName и middleName.
        firstName:
          type: string
          nullable: true
          description: Обязательное поле для обычного фермера.
        lastName:
          type: string
          nullable: true
          description: Обязательное поле для обычного фермера.
        middleName:
          type: string
          nullable: true
          description: Обязательное поле для обычного фермера.
        nickname:
          type: string
          nullable: true
          description: Обязательное поле для крутого фермера.
        passport:
          type: string
          nullable: true
          description: Обязательное поле для крутого фермера.
      description: |
        Тело запроса содержит только изменяемые поля профиля.
        В зависимости от значения `isCoolFarmer` указываются либо поля обычного фермера, либо данные крутого фермера.
    ShopPrices:
      type: object
      properties:
        purchase:
          type: object
          properties:
            basePrice: { type: integer }
            advPrice: { type: integer }
        sale:
          type: object
          properties:
            basePrice: { type: integer }
            advPrice: { type: integer }
        supplies:
          type: object
          properties:
            yogurt: { $ref: '#/components/schemas/SupplyPrice' }
            sunflowerOil: { $ref: '#/components/schemas/SupplyPrice' }
    SupplyPrice:
      type: object
      properties:
        price: { type: integer }
        volume: { type: integer }
    KitchenState:
      type: object
      properties:
        vegetables:
          type: object
          properties:
            mango: { type: integer, minimum: 0 }
            carrot: { type: integer, minimum: 0 }
            cabbage: { type: integer, minimum: 0 }
            radish: { type: integer, minimum: 0 }
          additionalProperties: false
        yogurtMl: { type: integer, minimum: 0 }
        sunflowerOilMl: { type: integer, minimum: 0 }
        saladsEaten: { type: integer, minimum: 0 }
        preparedSalads: { type: integer, minimum: 0 }
        isFatFarmer: { type: boolean }
    KitchenSaladReq:
      type: object
      required: [recipe]
      properties:
        recipe:
          type: string
          enum: [fruit, vegetable]
        ingredients:
          type: object
          description: |
            Необязательный объект с точными количествами ингредиентов.
            Значения должны в точности совпадать с требованиями выбранного рецепта.
          additionalProperties: false
          properties:
            mango: { type: integer, minimum: 0 }
            carrot: { type: integer, minimum: 0 }
            cabbage: { type: integer, minimum: 0 }
            radish: { type: integer, minimum: 0 }
            yogurtMl: { type: integer, minimum: 0 }
            sunflowerOilMl: { type: integer, minimum: 0 }
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
          example: Ошибка
        details:
          description: Дополнительная информация об ошибке.
          type: object
          additionalProperties: true
    OkResponse:
      type: object
      required: [ok]
      properties:
        ok:
          type: boolean
          example: true
    SupplyPurchaseResponse:
      allOf:
        - $ref: '#/components/schemas/OkResponse'
        - type: object
          required: [price, volume]
          properties:
            price: { type: integer }
            volume: { type: integer }
    InventoryItem:
      type: object
      properties:
        id: { type: integer }
        kind: { type: string, enum: [seed, veg_raw, veg_washed] }
        type: { type: string, enum: [radish, carrot, cabbage, mango, potato, eggplant] }
        status: { type: string }
        createdAt: { type: string, format: date-time }
        isRotten: { type: boolean }
    Plot:
      type: object
      properties:
        slot: { type: integer }
        type: { type: string, nullable: true }
        plantedAt: { type: string, format: date-time, nullable: true }
        matured: { type: boolean }
        harvested: { type: boolean }
    GardenPlotsResponse:
      type: object
      properties:
        plots:
          type: array
          items: { $ref: '#/components/schemas/Plot' }
        growthMinutes: { type: integer }
        canUproot:
          type: boolean
          description: "Флаг доступности выкапывания грядок (только для администратора)"
paths:
  /auth/register:
    post:
      summary: Регистрация
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AuthRegisterReq' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AuthRegisterResp' }
              example:
                accessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9
                refreshToken: dGhpc0lzQW5FbmNyeXB0ZWRSZWZyZXNoVG9rZW4
                message: Пользователь успешно зарегистрирован
  /auth/login:
    post:
      summary: Логин
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AuthLoginReq' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AuthTokens' }
              example:
                accessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9
                refreshToken: c29tZVNhbXBsZVJlZnJlc2hUb2tlbg
  /auth/refresh:
    post:
      summary: Обновить токены
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AuthRefreshReq' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AuthTokens' }
              example:
                accessToken: ZXhhbXBsZUFjY2Vzc1Rva2Vu
                refreshToken: ZXhhbXBsZVJlZnJlc2hUb2tlbg
  /profile:
    get:
      security: [{ bearerAuth: [] }]
      summary: Получить профиль
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Profile' }
              example:
                id: 1
                isCoolFarmer: true
                isAdmin: false
                firstName: Иван
                lastName: Иванов
                middleName: Иванович
                nickname: cool_farmer
                passport: 1234 567890
                level: 2
                soldCount: 7
                balance: 1250
                yogurtMl: 300
                sunflowerOilMl: 450
                saladsEaten: 9
                isFatFarmer: false
                prices:
                  purchase:
                    basePrice: 50
                    advPrice: 70
                  sale:
                    basePrice: 40
                    advPrice: 60
                  supplies:
                    yogurt:
                      price: 120
                      volume: 500
                    sunflowerOil:
                      price: 90
                      volume: 400
        '401':
          description: Требуется авторизация
    put:
      security: [{ bearerAuth: [] }]
      summary: Редактирование профиля
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProfileUpdateReq' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Profile' }
              example:
                id: 1
                isCoolFarmer: false
                isAdmin: false
                firstName: Ольга
                lastName: Смирнова
                middleName: Сергеевна
                nickname: null
                passport: null
                level: 1
                soldCount: 2
                balance: 900
                yogurtMl: 150
                sunflowerOilMl: 200
                saladsEaten: 3
                isFatFarmer: false
                prices:
                  purchase:
                    basePrice: 50
                    advPrice: 70
                  sale:
                    basePrice: 40
                    advPrice: 60
                  supplies:
                    yogurt:
                      price: 120
                      volume: 500
                    sunflowerOil:
                      price: 90
                      volume: 400
        '400':
          description: |
            Возможные ошибки:
              - «для крутого фермера нужен никнейм и паспорт» — если не переданы оба поля для крутого фермера.
              - «для обычного фермера нужно Ф.И.О.» — если отсутствуют Ф.И.О. для обычного режима.
  /profile/{id}:
    get:
      security: [{ bearerAuth: [] }]
      summary: Получить профиль по идентификатору
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Profile' }
              example:
                id: 2
                isCoolFarmer: true
                isAdmin: false
                firstName: null
                lastName: null
                middleName: null
                nickname: фермерша
                passport: 5678 123456
                level: 1
                soldCount: 0
                balance: 500
                yogurtMl: 200
                sunflowerOilMl: 120
                saladsEaten: 1
                isFatFarmer: false
                prices:
                  purchase:
                    basePrice: 50
                    advPrice: 70
                  sale:
                    basePrice: 40
                    advPrice: 60
                  supplies:
                    yogurt:
                      price: 120
                      volume: 500
                    sunflowerOil:
                      price: 90
                      volume: 400
        '404':
          description: Не найдено
  /shop/buy:
    post:
      security: [{ bearerAuth: [] }]
      summary: Купить семена
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [type]
              properties:
                type:
                  type: string
                  enum: [radish, carrot, cabbage, mango, potato, eggplant]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/OkResponse' }
              example:
                ok: true
  /shop/buy-supply:
    post:
      security: [{ bearerAuth: [] }]
      summary: Купить товар для кухни
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [supply]
              properties:
                supply:
                  type: string
                  enum: [yogurt, sunflowerOil]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SupplyPurchaseResponse' }
              example:
                ok: true
                price: 120
                volume: 500
  /shop/sell:
    post:
      security: [{ bearerAuth: [] }]
      summary: Продать помытый овощ
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [inventoryId]
              properties:
                inventoryId: { type: integer }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/OkResponse' }
              example:
                ok: true
        '404':
          description: Овощ с указанным идентификатором отсутствует
  /kitchen:
    get:
      security: [{ bearerAuth: [] }]
      summary: Получить состояние кухни
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/KitchenState' }
              example:
                vegetables:
                  mango: 1
                  carrot: 3
                  cabbage: 0
                  radish: 2
                yogurtMl: 250
                sunflowerOilMl: 180
                saladsEaten: 5
                preparedSalads: 1
                isFatFarmer: false
  /kitchen/salads:
    post:
      security: [{ bearerAuth: [] }]
      summary: Приготовить салат
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/KitchenSaladReq' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/KitchenState' }
              example:
                vegetables:
                  mango: 0
                  carrot: 2
                  cabbage: 1
                  radish: 1
                yogurtMl: 100
                sunflowerOilMl: 120
                saladsEaten: 6
                preparedSalads: 2
                isFatFarmer: false
        '400':
          description: Ошибка валидации ингредиентов или нехватка продуктов
  /kitchen/salads/eat:
    post:
      security: [{ bearerAuth: [] }]
      summary: Съесть приготовленный салат
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/KitchenState' }
              example:
                vegetables:
                  mango: 0
                  carrot: 1
                  cabbage: 1
                  radish: 0
                yogurtMl: 50
                sunflowerOilMl: 80
                saladsEaten: 7
                preparedSalads: 0
                isFatFarmer: false
  /inventory:
    get:
      security: [{ bearerAuth: [] }]
      summary: Инвентарь
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  seeds:
                    type: array
                    items: { $ref: '#/components/schemas/InventoryItem' }
                  vegRaw:
                    type: array
                    items: { $ref: '#/components/schemas/InventoryItem' }
                  vegWashed:
                    type: array
                    items: { $ref: '#/components/schemas/InventoryItem' }
                  vegRotten:
                    type: array
                    items: { $ref: '#/components/schemas/InventoryItem' }
              example:
                seeds:
                  - id: 1
                    kind: seed
                    type: carrot
                    status: stored
                    createdAt: '2024-06-01T12:00:00Z'
                    isRotten: false
                vegRaw:
                  - id: 2
                    kind: veg_raw
                    type: radish
                    status: harvested
                    createdAt: '2024-06-02T09:00:00Z'
                    isRotten: false
                vegWashed:
                  - id: 3
                    kind: veg_washed
                    type: cabbage
                    status: washed
                    createdAt: '2024-06-02T10:00:00Z'
                    isRotten: false
                vegRotten:
                  - id: 4
                    kind: veg_raw
                    type: mango
                    status: rotten
                    createdAt: '2024-05-30T08:00:00Z'
                    isRotten: true
  /inventory/{id}:
    delete:
      security: [{ bearerAuth: [] }]
      summary: Выкинуть протухший овощ
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/OkResponse' }
              example:
                ok: true
        '404':
          description: Овощ с указанным идентификатором отсутствует
  /inventory/wash/{id}:
    patch:
      security: [{ bearerAuth: [] }]
      summary: Помыть овощ
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/OkResponse' }
              example:
                ok: true
        '404':
          description: Овощ с указанным идентификатором отсутствует
        '409':
          description: Данный овощ чистый
  /garden/plots:
    get:
      security: [{ bearerAuth: [] }]
      summary: Состояние грядок
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/GardenPlotsResponse' }
              example:
                plots:
                  - slot: 1
                    type: carrot
                    plantedAt: '2024-06-02T08:00:00Z'
                    matured: true
                    harvested: false
                  - slot: 2
                    type: mango
                    plantedAt: '2024-06-02T08:10:00Z'
                    matured: false
                    harvested: false
                growthMinutes: 30
                canUproot: false
          
  /garden/plant:
    post:
      security: [{ bearerAuth: [] }]
      summary: Посадить семя в слот
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [slot, inventoryId]
              properties:
                slot: { type: integer }
                inventoryId: { type: integer }
      responses:
        '202':
          description: Задача посадки принята в очередь
        '400':
          description: Ошибка валидации
        '409':
          description: Грядка уже занята
        '503':
          description: Очередь посадки недоступна
  /garden/harvest:
    post:
      security: [{ bearerAuth: [] }]
      summary: Собрать созревший овощ
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [slot]
              properties:
                slot: { type: integer }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/OkResponse' }
              example:
                ok: true
        '409':
          description: 'Овощ ещё совсем зелёный'
  /garden/uproot/{slot}:
    delete:
      security: [{ bearerAuth: [] }]
      summary: Выкопать овощ до созревания (только админ)
      parameters:
        - in: path
          name: slot
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/OkResponse' }
              example:
                ok: true
        '403':
          description: Forbidden
